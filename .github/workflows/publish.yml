name: PowerNukkitX Publish

on:
  push:
  pull_request:

jobs:
  build-publish-maven:
    name: Build & Publish to Maven + Codecov
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository (Full)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      - name: Set Up JDK 21 (Temurin)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Restore Gradle cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make Gradle Wrapper Executable
        run: chmod +x gradlew

      - name: Build & Publish to Maven Repository
        run: ./gradlew publish --no-configuration-cache
        env:
          PNX_REPO_USERNAME: ${{ secrets.PNX_REPO_USERNAME }}
          PNX_REPO_PASSWORD: ${{ secrets.PNX_REPO_PASSWORD }}

      - name: Upload Test Results to Codecov
        if: success() && github.repository == 'PowerNukkitX/PowerNukkitX' && contains(github.ref_name, 'master')
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # v1.2.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  publish-next-major:
    name: Publish Next Major Nightly Build
    runs-on: ubuntu-latest
    needs: build-publish-maven
    if: github.ref == 'refs/heads/next-major'
    steps:
      - name: Checkout Source Code (Full)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      - name: Set Up JDK 21 (Temurin)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Restore Gradle cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make Gradle Wrapper Executable
        run: chmod +x gradlew

      - name: Build Project (Next Major)
        run: ./gradlew build --no-daemon --stacktrace

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v6
        with:
          name: powernukkitx-jar
          path: build/libs/*.jar

      - name: Publish Next Major Nightly (next-major)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: next-major
          prerelease: true
          name: "PowerNukkitX Next Major Nightly"
          body: |
            # PowerNukkitX Next Major Nightly
            This is the latest next major build of PowerNukkitX, built automatically from the [`next-major`](https://github.com/${{ github.repository }}/tree/next-major) branch.

            Note: The `next-major` tag remains the same, but the assets below are replaced on every push to this branch. These builds are for testing and feedback only and may be unstable or contain untested features.

            Commit: `${{ github.sha }}`

            ---
            ## Download
            - Download the latest `powernukkitx.jar` from the assets below.
            - Replace your server's JAR to try new features and fixes.

            ## How to Test
            1. Download the JAR below.
            2. Replace your server's `powernukkitx.jar`.
            3. Restart your server.
            4. Report any issues or feedback.

            ## Feedback & Issues
            - Join our [Discord](https://discord.gg/8bTGJ5FzY4) for discussion and support.
            - Report bugs or suggestions in [GitHub Issues](https://github.com/${{ github.repository }}/issues).

            Thank you for helping us improve PowerNukkitX!
          files: build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    name: Publish Official Release (Draft)
    runs-on: ubuntu-latest
    needs: build-publish-maven
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout Source Code (Full)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      - name: Set Up JDK 21 (Temurin)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Restore Gradle cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make Gradle Wrapper Executable
        run: chmod +x gradlew

      - name: Build Project (Release)
        run: ./gradlew build --no-daemon --stacktrace

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v6
        with:
          name: powernukkitx-jar
          path: build/libs/*.jar

      - name: Check Release Trigger (Commit Message)
        id: check_release
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          if [[ "$COMMIT_MSG" =~ ^(Release:|Version:) ]]; then
            echo "RELEASE_TRIGGER=true" >> $GITHUB_ENV
          else
            echo "RELEASE_TRIGGER=false" >> $GITHUB_ENV
          fi

      - name: Read API Version from Nukkit.java and ProtocolInfo.java
        if: env.RELEASE_TRIGGER == 'true'
        id: version
        run: |
          API_VERSION=$(grep 'public final static String API_VERSION' src/main/java/cn/nukkit/Nukkit.java | sed -E 's/.*"([^"\n]+)".*/\1/')
          MINECRAFT_VERSION_NETWORK=$(grep -E 'String[[:space:]]+MINECRAFT_VERSION_NETWORK[[:space:]]*=' src/main/java/cn/nukkit/network/protocol/ProtocolInfo.java | sed -E 's/.*"([^"\n]+)".*/\1/')
          echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
          echo "MINECRAFT_VERSION_NETWORK=$MINECRAFT_VERSION_NETWORK" >> $GITHUB_ENV

      - name: Publish Official Release (Draft)
        if: env.RELEASE_TRIGGER == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.API_VERSION }}
          prerelease: false
          draft: true
          name: "PowerNukkitX ${{ env.API_VERSION }} for ${{ env.MINECRAFT_VERSION_NETWORK }}"
          body: |
            # PowerNukkitX Release ${{ env.API_VERSION }}
            This is the latest official release of PowerNukkitX, built from the [`master`](https://github.com/${{ github.repository }}/tree/master) branch.

            API Version: `${{ env.API_VERSION }}`  
            Minecraft Protocol Version: `${{ env.MINECRAFT_VERSION_NETWORK }}`  
            Commit: `${{ github.sha }}`

            ---
            ## Download
            - Download the `powernukkitx.jar` file from the assets below.
            - Replace your server's JAR to update.

            ## Update Instructions
            1. Download the JAR below.
            2. Replace the `powernukkitx.jar` in your server directory.
            3. Restart your server.
            4. Benefit from the latest features and improvements.

            ## Support & Feedback
            - For help and discussion, join our [Discord](https://discord.gg/8bTGJ5FzY4).
            - To report issues or suggest improvements, use [GitHub Issues](https://github.com/${{ github.repository }}/issues).

            ---
            Thank you for choosing PowerNukkitX. Your feedback and contributions help us improve with every release.
          files: build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
